DESKTOP_ENVIRONMENT_BUILD_LAST_EXIT_CODE=$(cat $HOME/repositories/sabrehagen/desktop-environment/.build-exit-code)
BUILD_STARTED=$(tmux ls </dev/null | grep build-dotfiles.*: | sed -E 's/.*build-dotfiles-([^:]*):.*/\1/' | sort -nr | head -1)

if [ -n "$BUILD_STARTED" ]; then
  echo -n " "
  echo $BUILD_STARTED | timeago

  # Show build log on click
  if [ -n "$BLOCK_BUTTON" ]; then
    BUILD_TMUX_SESSION=$(tmux ls | grep build-dotfiles.*: | cut -d: -f1 | sort -nr | head -1)
    $HOME/.config/scripts/launch-alacritty.sh \
      --option window.dimensions.columns=108 \
      --option window.dimensions.lines=50 \
      --title i3bar_desktop-environment-build \
      --command zsh -c "tmux new-session -s i3bar_desktop-environment-build$(date +%s) -t $BUILD_TMUX_SESSION" >/dev/null 2>&1 &
  fi
else
  CONTAINER_CREATED_DATE=$(docker inspect desktop-environment --format='{{.Created}}' | xargs date +%s -d)
  CONTAINER_IMAGE_ID=$(docker inspect desktop-environment --format='{{.Config.Image}}')
  IMAGE_BUILD_DATE=$(docker inspect $CONTAINER_IMAGE_ID --format='{{.Created}}' | xargs date +%s -d)

  if [ "$DESKTOP_ENVIRONMENT_BUILD_LAST_EXIT_CODE" -ne 0 ]; then
    echo -n " "
  else
    echo -n " "
  fi

  echo $IMAGE_BUILD_DATE | timeago
  echo $IMAGE_BUILD_DATE | timeago

  if [ "$IMAGE_BUILD_DATE" -gt "$CONTAINER_CREATED_DATE" ]; then
    echo $(xrdb -query | grep *color2 | cut -d: -f2)
  fi
fi

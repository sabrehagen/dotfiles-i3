#!/bin/sh

SINK=${SINK:-0}
ALSA_CONTROL=${ALSA_CONTROL:-Master}
ALSA_CARD_OPT=""
[ -n "$ALSA_CARD" ] && ALSA_CARD_OPT="-c $ALSA_CARD"

backend="alsa"
if pgrep -x jackd >/dev/null 2>&1; then
  backend="jack"
fi

if [ "$backend" != "jack" ] && pactl info >/dev/null 2>&1; then
  backend="pulse"
fi

VOLUME=""
MUTED=0

if [ "$backend" = "pulse" ]; then
  pulse_data=$(pactl list sinks 2>/dev/null || true)
  volume_line=$(printf '%s\n' "$pulse_data" | grep '^[[:space:]]Volume:' | head -n $((SINK + 1)) | tail -n 1)
  mute_line=$(printf '%s\n' "$pulse_data" | grep '^[[:space:]]Mute:' | head -n $((SINK + 1)) | tail -n 1)
  VOLUME=$(printf '%s\n' "$volume_line" | sed -e 's,.* \([0-9][0-9]*\)%.*,\1,' )
  if printf '%s\n' "$mute_line" | grep -qi 'yes'; then
    MUTED=1
  fi
fi

if [ -z "$VOLUME" ]; then
  if [ "$backend" = "pulse" ]; then
    backend="alsa"
  fi
  alsa_data=$(amixer $ALSA_CARD_OPT get "$ALSA_CONTROL" 2>/dev/null || true)
  VOLUME=$(printf '%s\n' "$alsa_data" | grep -m1 -o '[0-9]\+%' | tr -d '%')
  if printf '%s\n' "$alsa_data" | grep -q '\[off\]'; then
    MUTED=1
  fi
fi

if [ -z "$VOLUME" ]; then
  exit 0
fi

if [ "$VOLUME" -ge 50 ]; then
  ICON=
else
  ICON=
fi

if [ "$MUTED" -eq 1 ]; then
  ICON=
fi

if [ -n "$BLOCK_BUTTON" ]; then
  if [ "$backend" = "pulse" ]; then
    mixer_cmd="pulsemixer"
    columns=108
    lines=6
  else
    mixer_cmd="alsamixer"
    columns=80
    lines=20
  fi

  alacritty \
    --option window.dimensions.columns="$columns" \
    --option window.dimensions.lines="$lines" \
    --title i3bar_volume \
    --command zsh -c "$mixer_cmd" &
fi

printf '%s %s%%\n' "$ICON" "$VOLUME"
printf '%s %s%%\n' "$ICON" "$VOLUME"

exit 0
